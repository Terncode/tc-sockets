"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.decodeString = exports.encodeStringTo = exports.stringLengthInBytes = void 0;
function charLengthInBytes(code) {
    if ((code & 0xffffff80) === 0) {
        return 1;
    }
    else if ((code & 0xfffff800) === 0) {
        return 2;
    }
    else if ((code & 0xffff0000) === 0) {
        return 3;
    }
    else {
        return 4;
    }
}
function stringLengthInBytes(value) {
    var result = 0;
    for (var i = 0; i < value.length; i++) {
        var code = value.charCodeAt(i);
        // high surrogate
        if (code >= 0xd800 && code <= 0xdbff) {
            if ((i + 1) < value.length) {
                var extra = value.charCodeAt(i + 1);
                // low surrogate
                if ((extra & 0xfc00) === 0xdc00) {
                    i++;
                    result += charLengthInBytes(((code & 0x3ff) << 10) + (extra & 0x3ff) + 0x10000);
                }
            }
        }
        else {
            result += charLengthInBytes(code);
        }
    }
    return result;
}
exports.stringLengthInBytes = stringLengthInBytes;
function writeCharacter(buffer, offset, code) {
    var length = charLengthInBytes(code);
    switch (length) {
        case 1:
            buffer.setUint8(offset, code);
            break;
        case 2:
            buffer.setUint8(offset, ((code >> 6) & 0x1f) | 0xc0);
            buffer.setUint8(offset + 1, (code & 0x3f) | 0x80);
            break;
        case 3:
            buffer.setUint8(offset, ((code >> 12) & 0x0f) | 0xe0);
            buffer.setUint8(offset + 1, ((code >> 6) & 0x3f) | 0x80);
            buffer.setUint8(offset + 2, (code & 0x3f) | 0x80);
            break;
        default:
            buffer.setUint8(offset, ((code >> 18) & 0x07) | 0xf0);
            buffer.setUint8(offset + 1, ((code >> 12) & 0x3f) | 0x80);
            buffer.setUint8(offset + 2, ((code >> 6) & 0x3f) | 0x80);
            buffer.setUint8(offset + 3, (code & 0x3f) | 0x80);
            break;
    }
    return length;
}
function encodeStringTo(buffer, offset, value) {
    for (var i = 0; i < value.length; i++) {
        var code = value.charCodeAt(i);
        // high surrogate
        if (code >= 0xd800 && code <= 0xdbff) {
            if ((i + 1) < value.length) {
                var extra = value.charCodeAt(i + 1);
                // low surrogate
                if ((extra & 0xfc00) === 0xdc00) {
                    i++;
                    var fullCode = ((code & 0x3ff) << 10) + (extra & 0x3ff) + 0x10000;
                    offset += writeCharacter(buffer, offset, fullCode);
                }
            }
        }
        else {
            offset += writeCharacter(buffer, offset, code);
        }
    }
    return offset;
}
exports.encodeStringTo = encodeStringTo;
function continuationByte(buffer, index, end) {
    if (index >= end)
        throw Error('Invalid byte index');
    var continuationByte = buffer.getUint8(index);
    if ((continuationByte & 0xC0) === 0x80) {
        return continuationByte & 0x3F;
    }
    else {
        throw Error('Invalid continuation byte');
    }
}
function decodeString(value, offset, length) {
    if (value == null)
        return null;
    var result = '';
    var end = offset + length;
    for (var i = offset; i < end;) {
        var byte1 = value.getUint8(i++);
        var code = void 0;
        if ((byte1 & 0x80) === 0) {
            code = byte1;
        }
        else if ((byte1 & 0xe0) === 0xc0) {
            var byte2 = continuationByte(value, i++, end);
            code = ((byte1 & 0x1f) << 6) | byte2;
            if (code < 0x80) {
                throw Error('Invalid continuation byte');
            }
        }
        else if ((byte1 & 0xf0) === 0xe0) {
            var byte2 = continuationByte(value, i++, end);
            var byte3 = continuationByte(value, i++, end);
            code = ((byte1 & 0x0f) << 12) | (byte2 << 6) | byte3;
            if (code < 0x0800) {
                throw Error('Invalid continuation byte');
            }
            if (code >= 0xd800 && code <= 0xdfff) {
                throw Error("Lone surrogate U+".concat(code.toString(16).toUpperCase(), " is not a scalar value"));
            }
        }
        else if ((byte1 & 0xf8) === 0xf0) {
            var byte2 = continuationByte(value, i++, end);
            var byte3 = continuationByte(value, i++, end);
            var byte4 = continuationByte(value, i++, end);
            code = ((byte1 & 0x0f) << 0x12) | (byte2 << 0x0c) | (byte3 << 0x06) | byte4;
            if (code < 0x010000 || code > 0x10ffff) {
                throw Error('Invalid continuation byte');
            }
        }
        else {
            throw Error('Invalid UTF-8 detected');
        }
        if (code > 0xffff) {
            code -= 0x10000;
            result += String.fromCharCode(code >>> 10 & 0x3ff | 0xd800);
            code = 0xdc00 | code & 0x3ff;
        }
        result += String.fromCharCode(code);
    }
    return result;
}
exports.decodeString = decodeString;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q2YsQ0FBQztBQXRERCxvQ0FzREMiLCJmaWxlIjoiY29tbW9uL3V0ZjguanMiLCJzb3VyY2VzQ29udGVudCI6WyJmdW5jdGlvbiBjaGFyTGVuZ3RoSW5CeXRlcyhjb2RlOiBudW1iZXIpOiBudW1iZXIge1xuXHRpZiAoKGNvZGUgJiAweGZmZmZmZjgwKSA9PT0gMCkge1xuXHRcdHJldHVybiAxO1xuXHR9IGVsc2UgaWYgKChjb2RlICYgMHhmZmZmZjgwMCkgPT09IDApIHtcblx0XHRyZXR1cm4gMjtcblx0fSBlbHNlIGlmICgoY29kZSAmIDB4ZmZmZjAwMDApID09PSAwKSB7XG5cdFx0cmV0dXJuIDM7XG5cdH0gZWxzZSB7XG5cdFx0cmV0dXJuIDQ7XG5cdH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN0cmluZ0xlbmd0aEluQnl0ZXModmFsdWU6IHN0cmluZyk6IG51bWJlciB7XG5cdGxldCByZXN1bHQgPSAwO1xuXG5cdGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWUubGVuZ3RoOyBpKyspIHtcblx0XHRjb25zdCBjb2RlID0gdmFsdWUuY2hhckNvZGVBdChpKTtcblxuXHRcdC8vIGhpZ2ggc3Vycm9nYXRlXG5cdFx0aWYgKGNvZGUgPj0gMHhkODAwICYmIGNvZGUgPD0gMHhkYmZmKSB7XG5cdFx0XHRpZiAoKGkgKyAxKSA8IHZhbHVlLmxlbmd0aCkge1xuXHRcdFx0XHRjb25zdCBleHRyYSA9IHZhbHVlLmNoYXJDb2RlQXQoaSArIDEpO1xuXG5cdFx0XHRcdC8vIGxvdyBzdXJyb2dhdGVcblx0XHRcdFx0aWYgKChleHRyYSAmIDB4ZmMwMCkgPT09IDB4ZGMwMCkge1xuXHRcdFx0XHRcdGkrKztcblx0XHRcdFx0XHRyZXN1bHQgKz0gY2hhckxlbmd0aEluQnl0ZXMoKChjb2RlICYgMHgzZmYpIDw8IDEwKSArIChleHRyYSAmIDB4M2ZmKSArIDB4MTAwMDApO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdHJlc3VsdCArPSBjaGFyTGVuZ3RoSW5CeXRlcyhjb2RlKTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiB3cml0ZUNoYXJhY3RlcihidWZmZXI6IERhdGFWaWV3LCBvZmZzZXQ6IG51bWJlciwgY29kZTogbnVtYmVyKTogbnVtYmVyIHtcblx0Y29uc3QgbGVuZ3RoID0gY2hhckxlbmd0aEluQnl0ZXMoY29kZSk7XG5cblx0c3dpdGNoIChsZW5ndGgpIHtcblx0XHRjYXNlIDE6XG5cdFx0XHRidWZmZXIuc2V0VWludDgob2Zmc2V0LCBjb2RlKTtcblx0XHRcdGJyZWFrO1xuXHRcdGNhc2UgMjpcblx0XHRcdGJ1ZmZlci5zZXRVaW50OChvZmZzZXQsICgoY29kZSA+PiA2KSAmIDB4MWYpIHwgMHhjMCk7XG5cdFx0XHRidWZmZXIuc2V0VWludDgob2Zmc2V0ICsgMSwgKGNvZGUgJiAweDNmKSB8IDB4ODApO1xuXHRcdFx0YnJlYWs7XG5cdFx0Y2FzZSAzOlxuXHRcdFx0YnVmZmVyLnNldFVpbnQ4KG9mZnNldCwgKChjb2RlID4+IDEyKSAmIDB4MGYpIHwgMHhlMCk7XG5cdFx0XHRidWZmZXIuc2V0VWludDgob2Zmc2V0ICsgMSwgKChjb2RlID4+IDYpICYgMHgzZikgfCAweDgwKTtcblx0XHRcdGJ1ZmZlci5zZXRVaW50OChvZmZzZXQgKyAyLCAoY29kZSAmIDB4M2YpIHwgMHg4MCk7XG5cdFx0XHRicmVhaztcblx0XHRkZWZhdWx0OlxuXHRcdFx0YnVmZmVyLnNldFVpbnQ4KG9mZnNldCwgKChjb2RlID4+IDE4KSAmIDB4MDcpIHwgMHhmMCk7XG5cdFx0XHRidWZmZXIuc2V0VWludDgob2Zmc2V0ICsgMSwgKChjb2RlID4+IDEyKSAmIDB4M2YpIHwgMHg4MCk7XG5cdFx0XHRidWZmZXIuc2V0VWludDgob2Zmc2V0ICsgMiwgKChjb2RlID4+IDYpICYgMHgzZikgfCAweDgwKTtcblx0XHRcdGJ1ZmZlci5zZXRVaW50OChvZmZzZXQgKyAzLCAoY29kZSAmIDB4M2YpIHwgMHg4MCk7XG5cdFx0XHRicmVhaztcblx0fVxuXG5cdHJldHVybiBsZW5ndGg7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBlbmNvZGVTdHJpbmdUbyhidWZmZXI6IERhdGFWaWV3LCBvZmZzZXQ6IG51bWJlciwgdmFsdWU6IHN0cmluZyk6IG51bWJlciB7XG5cdGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWUubGVuZ3RoOyBpKyspIHtcblx0XHRjb25zdCBjb2RlID0gdmFsdWUuY2hhckNvZGVBdChpKTtcblxuXHRcdC8vIGhpZ2ggc3Vycm9nYXRlXG5cdFx0aWYgKGNvZGUgPj0gMHhkODAwICYmIGNvZGUgPD0gMHhkYmZmKSB7XG5cdFx0XHRpZiAoKGkgKyAxKSA8IHZhbHVlLmxlbmd0aCkge1xuXHRcdFx0XHRjb25zdCBleHRyYSA9IHZhbHVlLmNoYXJDb2RlQXQoaSArIDEpO1xuXG5cdFx0XHRcdC8vIGxvdyBzdXJyb2dhdGVcblx0XHRcdFx0aWYgKChleHRyYSAmIDB4ZmMwMCkgPT09IDB4ZGMwMCkge1xuXHRcdFx0XHRcdGkrKztcblx0XHRcdFx0XHRjb25zdCBmdWxsQ29kZSA9ICgoY29kZSAmIDB4M2ZmKSA8PCAxMCkgKyAoZXh0cmEgJiAweDNmZikgKyAweDEwMDAwO1xuXHRcdFx0XHRcdG9mZnNldCArPSB3cml0ZUNoYXJhY3RlcihidWZmZXIsIG9mZnNldCwgZnVsbENvZGUpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdG9mZnNldCArPSB3cml0ZUNoYXJhY3RlcihidWZmZXIsIG9mZnNldCwgY29kZSk7XG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIG9mZnNldDtcbn1cblxuZnVuY3Rpb24gY29udGludWF0aW9uQnl0ZShidWZmZXI6IERhdGFWaWV3LCBpbmRleDogbnVtYmVyLCBlbmQ6IG51bWJlcik6IG51bWJlciB7XG5cdGlmIChpbmRleCA+PSBlbmQpIHRocm93IEVycm9yKCdJbnZhbGlkIGJ5dGUgaW5kZXgnKTtcblxuXHRjb25zdCBjb250aW51YXRpb25CeXRlID0gYnVmZmVyLmdldFVpbnQ4KGluZGV4KTtcblxuXHRpZiAoKGNvbnRpbnVhdGlvbkJ5dGUgJiAweEMwKSA9PT0gMHg4MCkge1xuXHRcdHJldHVybiBjb250aW51YXRpb25CeXRlICYgMHgzRjtcblx0fSBlbHNlIHtcblx0XHR0aHJvdyBFcnJvcignSW52YWxpZCBjb250aW51YXRpb24gYnl0ZScpO1xuXHR9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWNvZGVTdHJpbmcodmFsdWU6IERhdGFWaWV3IHwgbnVsbCwgb2Zmc2V0OiBudW1iZXIsIGxlbmd0aDogbnVtYmVyKTogc3RyaW5nIHwgbnVsbCB7XG5cdGlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm4gbnVsbDtcblxuXHRsZXQgcmVzdWx0ID0gJyc7XG5cdGNvbnN0IGVuZCA9IG9mZnNldCArIGxlbmd0aDtcblxuXHRmb3IgKGxldCBpID0gb2Zmc2V0OyBpIDwgZW5kOykge1xuXHRcdGNvbnN0IGJ5dGUxID0gdmFsdWUuZ2V0VWludDgoaSsrKTtcblx0XHRsZXQgY29kZTogbnVtYmVyO1xuXG5cdFx0aWYgKChieXRlMSAmIDB4ODApID09PSAwKSB7XG5cdFx0XHRjb2RlID0gYnl0ZTE7XG5cdFx0fSBlbHNlIGlmICgoYnl0ZTEgJiAweGUwKSA9PT0gMHhjMCkge1xuXHRcdFx0Y29uc3QgYnl0ZTIgPSBjb250aW51YXRpb25CeXRlKHZhbHVlLCBpKyssIGVuZCk7XG5cdFx0XHRjb2RlID0gKChieXRlMSAmIDB4MWYpIDw8IDYpIHwgYnl0ZTI7XG5cblx0XHRcdGlmIChjb2RlIDwgMHg4MCkge1xuXHRcdFx0XHR0aHJvdyBFcnJvcignSW52YWxpZCBjb250aW51YXRpb24gYnl0ZScpO1xuXHRcdFx0fVxuXHRcdH0gZWxzZSBpZiAoKGJ5dGUxICYgMHhmMCkgPT09IDB4ZTApIHtcblx0XHRcdGNvbnN0IGJ5dGUyID0gY29udGludWF0aW9uQnl0ZSh2YWx1ZSwgaSsrLCBlbmQpO1xuXHRcdFx0Y29uc3QgYnl0ZTMgPSBjb250aW51YXRpb25CeXRlKHZhbHVlLCBpKyssIGVuZCk7XG5cdFx0XHRjb2RlID0gKChieXRlMSAmIDB4MGYpIDw8IDEyKSB8IChieXRlMiA8PCA2KSB8IGJ5dGUzO1xuXG5cdFx0XHRpZiAoY29kZSA8IDB4MDgwMCkge1xuXHRcdFx0XHR0aHJvdyBFcnJvcignSW52YWxpZCBjb250aW51YXRpb24gYnl0ZScpO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoY29kZSA+PSAweGQ4MDAgJiYgY29kZSA8PSAweGRmZmYpIHtcblx0XHRcdFx0dGhyb3cgRXJyb3IoYExvbmUgc3Vycm9nYXRlIFUrJHtjb2RlLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpfSBpcyBub3QgYSBzY2FsYXIgdmFsdWVgKTtcblx0XHRcdH1cblx0XHR9IGVsc2UgaWYgKChieXRlMSAmIDB4ZjgpID09PSAweGYwKSB7XG5cdFx0XHRjb25zdCBieXRlMiA9IGNvbnRpbnVhdGlvbkJ5dGUodmFsdWUsIGkrKywgZW5kKTtcblx0XHRcdGNvbnN0IGJ5dGUzID0gY29udGludWF0aW9uQnl0ZSh2YWx1ZSwgaSsrLCBlbmQpO1xuXHRcdFx0Y29uc3QgYnl0ZTQgPSBjb250aW51YXRpb25CeXRlKHZhbHVlLCBpKyssIGVuZCk7XG5cdFx0XHRjb2RlID0gKChieXRlMSAmIDB4MGYpIDw8IDB4MTIpIHwgKGJ5dGUyIDw8IDB4MGMpIHwgKGJ5dGUzIDw8IDB4MDYpIHwgYnl0ZTQ7XG5cblx0XHRcdGlmIChjb2RlIDwgMHgwMTAwMDAgfHwgY29kZSA+IDB4MTBmZmZmKSB7XG5cdFx0XHRcdHRocm93IEVycm9yKCdJbnZhbGlkIGNvbnRpbnVhdGlvbiBieXRlJyk7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRocm93IEVycm9yKCdJbnZhbGlkIFVURi04IGRldGVjdGVkJyk7XG5cdFx0fVxuXG5cdFx0aWYgKGNvZGUgPiAweGZmZmYpIHtcblx0XHRcdGNvZGUgLT0gMHgxMDAwMDtcblx0XHRcdHJlc3VsdCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGNvZGUgPj4+IDEwICYgMHgzZmYgfCAweGQ4MDApO1xuXHRcdFx0Y29kZSA9IDB4ZGMwMCB8IGNvZGUgJiAweDNmZjtcblx0XHR9XG5cblx0XHRyZXN1bHQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjb2RlKTtcblx0fVxuXG5cdHJldHVybiByZXN1bHQ7XG59XG4iXSwic291cmNlUm9vdCI6Ii9ob21lL2FscGhhL0Rlc2t0b3AvZGV2L3RjLXNvY2tldHMvc3JjIn0=
